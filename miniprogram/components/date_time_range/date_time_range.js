"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("./util");
Component({
    properties: {
        value: {
            type: Array,
            value: []
        },
        layout: {
            type: String,
            value: 'year, month, day, hours, minutes'
        },
        selectedIndex: {
            type: Array,
            value: [0, 0, 0, 0, 0, 0]
        }
    },
    data: {
        visible: false,
        progress: 0,
        scrollTop: [],
        px2rpxRatio: 2,
        timer: null,
        setTop: false,
        date: [],
        layoutData: []
    },
    attached: function () {
        var _this = this;
        this.setData({ progress: 0 });
        wx.getSystemInfo({ success: function (res) { return _this.data.px2rpxRatio = 750 / res.windowWidth; } });
    },
    methods: {
        switchPicker: function () {
            this.setData({
                visible: !this.data.visible,
                progress: 0
            });
        },
        none: function () {
        },
        go: function () {
            if (!this.data.progress) {
                this.ok();
            }
            else {
                this.setData({ progress: 0 });
            }
        },
        ok: function () {
            var _this = this;
            var date = new Date();
            this.data.layoutData.forEach(function (v, i) {
                var selected = v[_this.data.selectedIndex[i]];
                var _a = selected.match(/(\d+)([^\d]){1}/), num = _a[1], unit = _a[2];
                switch (unit) {
                    case '年':
                        date.setFullYear(+num);
                        break;
                    case '月':
                        date.setMonth(+num - 1);
                        break;
                    case '日':
                        date.setDate(+num);
                        break;
                    case '时':
                        date.setHours(+num);
                        break;
                    case '分':
                        date.setMinutes(+num);
                        break;
                    case '秒':
                        date.setSeconds(+num);
                        break;
                    default:
                }
            });
            var value = this.data.value;
            value[this.data.progress] = date.getTime();
            this.data.value = value = value.filter(function (v) { return !!v; }).sort(function (a, b) { return a - b; });
            if (this.data.progress) {
                this.switchPicker();
            }
            else {
                this.setData({ progress: 1 });
            }
            this.triggerEvent('input', value, {});
        },
        scroll: function (e) {
            var _a;
            if (this.data.setTop) {
                return this.data.setTop = false;
                ;
            }
            var itemIndex = e.target.dataset.index;
            var index = Math.round(e.detail.scrollTop / 64 * this.data.px2rpxRatio);
            this.setData((_a = {},
                _a["selectedIndex[" + itemIndex + "]"] = index,
                _a));
        },
        setScrollIndex: function (e) {
            var _a;
            var itemIndex = e.target.dataset.index;
            if (itemIndex != null) {
                var index = e.currentTarget.dataset.index;
                this.setData((_a = {},
                    _a["selectedIndex[" + index + "]"] = itemIndex,
                    _a));
            }
        }
    },
    observers: {
        'selectedIndex.**': function (val) {
            var _this = this;
            if (this.data.timer) {
                clearTimeout(this.data.timer);
                this.data.timer = null;
            }
            this.data.timer = setTimeout(function () {
                _this.data.setTop = true;
                _this.setData({ scrollTop: val.map(function (v) { return v * 64; }) });
            }, 100);
        },
        'value.**, progress, layout': function (value, progress, layout) {
            value = value.filter(function (v) { return !!v; });
            while (value.length < 2) {
                value.push(Date.now());
            }
            this.data.value = value = value.sort(function (a, b) { return a - b; });
            var date = value.map(function (v) { return util_1.formatTime(layout, v); });
            var layoutData = util_1.getLayoutData(layout, value[progress]);
            this.setData({
                date: date, layoutData: layoutData,
                selectedIndex: util_1.calcSelIndex(layoutData, this.data.value[this.data.progress])
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZV90aW1lX3JhbmdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGF0ZV90aW1lX3JhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsK0JBQWlFO0FBcUJqRSxTQUFTLENBQXFCO0lBQzFCLFVBQVUsRUFBRTtRQUNSLEtBQUssRUFBRTtZQUNILElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLEVBQUU7U0FDWjtRQUNELE1BQU0sRUFBRTtZQUNKLElBQUksRUFBRSxNQUFNO1lBQ1osS0FBSyxFQUFFLGtDQUFrQztTQUM1QztRQUVELGFBQWEsRUFBRTtZQUNYLElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDNUI7S0FDSjtJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLENBQUM7UUFDWCxTQUFTLEVBQUUsRUFBRTtRQUNiLFdBQVcsRUFBRSxDQUFDO1FBQ2QsS0FBSyxFQUFFLElBQUk7UUFDWCxNQUFNLEVBQUUsS0FBSztRQUNiLElBQUksRUFBRSxFQUFFO1FBQ1IsVUFBVSxFQUFFLEVBQUU7S0FDakI7SUFDRCxRQUFRO1FBQVIsaUJBR0M7UUFGRyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDOUIsRUFBRSxDQUFDLGFBQWEsQ0FBQyxFQUFFLE9BQU8sRUFBRSxVQUFBLEdBQUcsSUFBSSxPQUFBLEtBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsV0FBVyxFQUE3QyxDQUE2QyxFQUFFLENBQUMsQ0FBQztJQUN4RixDQUFDO0lBQ0QsT0FBTyxFQUFFO1FBQ0wsWUFBWTtZQUNSLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1QsT0FBTyxFQUFFLENBQUMsSUFB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Q0QsNEJBQTRCLEVBQUUsVUFBVSxLQUFlLEVBQUUsUUFBZ0IsRUFBRSxNQUFjO1lBQ3JGLEtBQUssR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLENBQUMsRUFBSCxDQUFHLENBQUMsQ0FBQztZQUMvQixPQUFPLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUNyQixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO2FBQzFCO1lBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBQyxDQUFDLEVBQUUsQ0FBQyxJQUFLLE9BQUEsQ0FBQyxHQUFHLENBQUMsRUFBTCxDQUFLLENBQUMsQ0FBQztZQUV0RCxJQUFNLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsaUJBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLEVBQXJCLENBQXFCLENBQUMsQ0FBQztZQUNuRCxJQUFNLFVBQVUsR0FBRyxvQkFBYSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUUxRCxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULElBQUksTUFBQSxFQUFFLFVBQVUsWUFBQTtnQkFDaEIsYUFBYSxFQUFFLG1CQUFZLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDL0UsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIOaXpeacn+aXtumXtOiMg+WbtOmAieaLqeWZqFxyXG4gKi9cclxuaW1wb3J0IHsgZ2V0TGF5b3V0RGF0YSwgY2FsY1NlbEluZGV4LCBmb3JtYXRUaW1lIH0gZnJvbSAnLi91dGlsJztcclxuXHJcbmludGVyZmFjZSBJUmFuZ2VEYXRhIHtcclxuICAgIHZhbHVlOiBudW1iZXJbXTtcclxuICAgIHZpc2libGU6IGJvb2xlYW47XHJcbiAgICBsYXlvdXQ6IHN0cmluZztcclxuICAgIGxheW91dERhdGE6IHN0cmluZ1tdW107XHJcbiAgICBweDJycHhSYXRpbzogbnVtYmVyO1xyXG4gICAgdGltZXI6IG51bWJlciB8IG51bGw7XHJcbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXJbXTtcclxuICAgIHNjcm9sbFRvcDogbnVtYmVyW10sXHJcbiAgICBzZXRUb3A6IGJvb2xlYW47XHJcbiAgICBwcm9ncmVzczogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVJhbmdlIGV4dGVuZHMgV3hDb21wb25lbnQge1xyXG4gICAgZGF0YTogSVJhbmdlRGF0YTtcclxuICAgIHN3aXRjaFBpY2tlcigpOiB2b2lkO1xyXG4gICAgb2soKTogdm9pZDtcclxufVxyXG5cclxuQ29tcG9uZW50PElSYW5nZSwgSVJhbmdlRGF0YT4oe1xyXG4gICAgcHJvcGVydGllczoge1xyXG4gICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgIHR5cGU6IEFycmF5LFxyXG4gICAgICAgICAgICB2YWx1ZTogW11cclxuICAgICAgICB9LFxyXG4gICAgICAgIGxheW91dDoge1xyXG4gICAgICAgICAgICB0eXBlOiBTdHJpbmcsXHJcbiAgICAgICAgICAgIHZhbHVlOiAneWVhciwgbW9udGgsIGRheSwgaG91cnMsIG1pbnV0ZXMnXHJcbiAgICAgICAgfSxcclxuICAgICAgICAvLyDpgInkuK3nmoTntKLlvJVcclxuICAgICAgICBzZWxlY3RlZEluZGV4OiB7XHJcbiAgICAgICAgICAgIHR5cGU6IEFycmF5LFxyXG4gICAgICAgICAgICB2YWx1ZTogWzAsIDAsIDAsIDAsIDAsIDBdXHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIGRhdGE6IHtcclxuICAgICAgICB2aXNpYmxlOiBmYWxzZSxcclxuICAgICAgICBwcm9ncmVzczogMCxcclxuICAgICAgICBzY3JvbGxUb3A6IFtdLCAvLyDmu5rliqjpq5jluqZcclxuICAgICAgICBweDJycHhSYXRpbzogMiwgLy8gMXB4LzFycHhcclxuICAgICAgICB0aW1lcjogbnVsbCxcclxuICAgICAgICBzZXRUb3A6IGZhbHNlLCAvLyDmmK/lkKbmmK/nlLHkuo7orr7nva7mu5rliqjlgLzlvJXlj5HnmoTmu5rliqhcclxuICAgICAgICBkYXRlOiBbXSxcclxuICAgICAgICBsYXlvdXREYXRhOiBbXVxyXG4gICAgfSxcclxuICAgIGF0dGFjaGVkKCkge1xyXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAwIH0pO1xyXG4gICAgICAgIHd4LmdldFN5c3RlbUluZm8oeyBzdWNjZXNzOiByZXMgPT4gdGhpcy5kYXRhLnB4MnJweFJhdGlvID0gNzUwIC8gcmVzLndpbmRvd1dpZHRoIH0pO1xyXG4gICAgfSxcclxuICAgIG1ldGhvZHM6IHtcclxuICAgICAgICBzd2l0Y2hQaWNrZXIoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICB2aXNpYmxlOiAhdGhpcy5kYXRhLnZpc2libGUsXHJcbiAgICAgICAgICAgICAgICBwcm9ncmVzczogMFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG5vbmUoKSB7XHJcbiAgICAgICAgICAgIC8vXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnbygpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmRhdGEucHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub2soKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAwIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvaygpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YS5sYXlvdXREYXRhLmZvckVhY2goKHYsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdlt0aGlzLmRhdGEuc2VsZWN0ZWRJbmRleFtpXV07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBbLCBudW0sIHVuaXRdID0gPHN0cmluZ1tdPnNlbGVjdGVkLm1hdGNoKC8oXFxkKykoW15cXGRdKXsxfS8pO1xyXG5cclxuICAgICAgICAgICAgICAgIHN3aXRjaCAodW5pdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+W5tCc6IGRhdGUuc2V0RnVsbFllYXIoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+aciCc6IGRhdGUuc2V0TW9udGgoK251bSAtIDEpOyBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICfml6UnOiBkYXRlLnNldERhdGUoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+aXtic6IGRhdGUuc2V0SG91cnMoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+WIhic6IGRhdGUuc2V0TWludXRlcygrbnVtKTsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn56eSJzogZGF0ZS5zZXRTZWNvbmRzKCtudW0pOyBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgdmFsdWVbdGhpcy5kYXRhLnByb2dyZXNzXSA9IGRhdGUuZ2V0VGltZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgPSB2YWx1ZSA9IHZhbHVlLmZpbHRlcih2ID0+ICEhdikuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS5wcm9ncmVzcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zd2l0Y2hQaWNrZXIoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAxIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRyaWdnZXJFdmVudCgnaW5wdXQnLCB2YWx1ZSwge30pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2Nyb2xsKGU6IEJhc2VFdmVudCk6IGZhbHNlIHwgdm9pZCB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEuc2V0VG9wKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnNldFRvcCA9IGZhbHNlOztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgaXRlbUluZGV4ID0gZS50YXJnZXQuZGF0YXNldC5pbmRleDtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBNYXRoLnJvdW5kKGUuZGV0YWlsLnNjcm9sbFRvcCAvIDY0ICogdGhpcy5kYXRhLnB4MnJweFJhdGlvKTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIFtgc2VsZWN0ZWRJbmRleFske2l0ZW1JbmRleH1dYF06IGluZGV4XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0U2Nyb2xsSW5kZXgoZTogQmFzZUV2ZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IGUudGFyZ2V0LmRhdGFzZXQuaW5kZXg7XHJcbiAgICAgICAgICAgIGlmIChpdGVtSW5kZXggIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbmRleDtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgW2BzZWxlY3RlZEluZGV4WyR7aW5kZXh9XWBdOiBpdGVtSW5kZXhcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9ic2VydmVyczoge1xyXG4gICAgICAgICdzZWxlY3RlZEluZGV4LioqJzogZnVuY3Rpb24gKHZhbDogbnVtYmVyW10pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS50aW1lcikge1xyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGF0YS50aW1lcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGEudGltZXIgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRhdGEudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5zZXRUb3AgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgc2Nyb2xsVG9wOiB2YWwubWFwKHYgPT4gdiAqIDY0KSB9KTtcclxuICAgICAgICAgICAgfSwgMTAwKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICd2YWx1ZS4qKiwgcHJvZ3Jlc3MsIGxheW91dCc6IGZ1bmN0aW9uICh2YWx1ZTogbnVtYmVyW10sIHByb2dyZXNzOiBudW1iZXIsIGxheW91dDogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHZhbHVlID0gdmFsdWUuZmlsdGVyKHYgPT4gISF2KTtcclxuICAgICAgICAgICAgd2hpbGUgKHZhbHVlLmxlbmd0aCA8IDIpIHtcclxuICAgICAgICAgICAgICAgIHZhbHVlLnB1c2goRGF0ZS5ub3coKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5kYXRhLnZhbHVlID0gdmFsdWUgPSB2YWx1ZS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XHJcblxyXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gdmFsdWUubWFwKHYgPT4gZm9ybWF0VGltZShsYXlvdXQsIHYpKTtcclxuICAgICAgICAgICAgY29uc3QgbGF5b3V0RGF0YSA9IGdldExheW91dERhdGEobGF5b3V0LCB2YWx1ZVtwcm9ncmVzc10pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIGRhdGUsIGxheW91dERhdGEsXHJcbiAgICAgICAgICAgICAgICBzZWxlY3RlZEluZGV4OiBjYWxjU2VsSW5kZXgobGF5b3V0RGF0YSwgdGhpcy5kYXRhLnZhbHVlW3RoaXMuZGF0YS5wcm9ncmVzc10pXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcbiJdfQ==