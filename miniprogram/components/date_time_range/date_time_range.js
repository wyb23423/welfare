"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("./util");
Component({
    properties: {
        value: {
            type: Array,
            value: [Date.now(), Date.now()]
        },
        layout: {
            type: String,
            value: 'year, month, day, hours, minutes'
        },
        selectedIndex: {
            type: Array,
            value: [0, 0, 0, 0, 0, 0]
        }
    },
    data: {
        visible: false,
        progress: 0,
        scrollTop: [],
        px2rpxRatio: 2,
        timer: null,
        setTop: false,
        date: [],
        layoutData: []
    },
    attached: function () {
        var _this = this;
        this.setData({ value: this.data.value.filter(function (v) { return !!v; }).sort(function (a, b) { return a - b; }) });
        wx.getSystemInfo({ success: function (res) { return _this.data.px2rpxRatio = 750 / res.windowWidth; } });
    },
    methods: {
        switchPicker: function () {
            this.setData({
                visible: !this.data.visible,
                progress: 0
            });
        },
        none: function () {
        },
        go: function () {
            if (!this.data.progress) {
                this.ok();
            }
            else {
                this.setData({ progress: 0 });
            }
        },
        ok: function () {
            var _this = this;
            var date = new Date();
            this.data.layoutData.forEach(function (v, i) {
                var selected = v[_this.data.selectedIndex[i]];
                var _a = selected.match(/(\d+)([^\d]){1}/), num = _a[1], unit = _a[2];
                switch (unit) {
                    case '年':
                        date.setFullYear(+num);
                        break;
                    case '月':
                        date.setMonth(+num - 1);
                        break;
                    case '日':
                        date.setDate(+num);
                        break;
                    case '时':
                        date.setHours(+num);
                        break;
                    case '分':
                        date.setMinutes(+num);
                        break;
                    case '秒':
                        date.setSeconds(+num);
                        break;
                    default:
                }
            });
            var value = this.data.value;
            value[this.data.progress] = date.getTime();
            this.data.value = value = value.filter(function (v) { return !!v; }).sort(function (a, b) { return a - b; });
            if (this.data.progress) {
                this.switchPicker();
            }
            else {
                this.setData({ progress: 1 });
            }
            this.triggerEvent('input', value, {});
        },
        scroll: function (e) {
            var _a;
            if (this.data.setTop) {
                return this.data.setTop = false;
                ;
            }
            var itemIndex = e.target.dataset.index;
            var index = Math.round(e.detail.scrollTop / 64 * this.data.px2rpxRatio);
            this.setData((_a = {},
                _a["selectedIndex[" + itemIndex + "]"] = index,
                _a));
        },
        setScrollIndex: function (e) {
            var _a;
            var itemIndex = e.target.dataset.index;
            if (itemIndex != null) {
                var index = e.currentTarget.dataset.index;
                this.setData((_a = {},
                    _a["selectedIndex[" + index + "]"] = itemIndex,
                    _a));
            }
        }
    },
    observers: {
        'selectedIndex.**': function (val) {
            var _this = this;
            if (this.data.timer) {
                clearTimeout(this.data.timer);
                this.data.timer = null;
            }
            this.data.timer = setTimeout(function () {
                _this.data.setTop = true;
                _this.setData({ scrollTop: val.map(function (v) { return v * 64; }) });
            }, 100);
        },
        'value.**, progress, layout': function (value, progress, layout) {
            var date = [];
            var layoutData = [];
            if (Array.isArray(value)) {
                date = value.map(function (v) { return util_1.formatTime(layout, v); });
                layoutData = util_1.getLayoutData(layout, value[progress]);
            }
            this.setData({
                date: date, layoutData: layoutData,
                selectedIndex: util_1.calcSelIndex(layoutData, this.data.value[this.data.progress])
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZV90aW1lX3JhbmdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGF0ZV90aW1lX3JhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsK0JBQWlFO0FBcUJqRSxTQUFTLENBQXFCO0lBQzFCLFVBQVUsRUFBRTtRQUNSLEtBQUssRUFBRTtZQUNILElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNsQztRQUNELE1BQU0sRUFBRTtZQUNKLElBQUksRUFBRSxNQUFNO1lBQ1osS0FBSyxFQUFFLGtDQUFrQztTQUM1QztRQUVELGFBQWEsRUFBRTtZQUNYLElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDNUI7S0FDSjtJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLENBQUM7UUFDWCxTQUFTLEVBQUUsRUFBRTtRQUNiLFdBQVcsRUFBRSxDQUFDO1FBQ2QsS0FBSyxFQUFFLElBQUk7UUFDWCxNQUFNLEVBQUUsS0FBSztRQUNiLElBQUksRUFBRSxFQUFFO1FBQ1IsVUFBVSxFQUFFLEVBQUU7S0FDakI7SUFDRCxRQUFRO1FBQVIsaUJBR0M7UUFGRyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxFQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBTSxDQUFDLE1BQU0sQ0FBQyxVQUFBLENBQUMsSUFBSSxPQUFBLENBQUMsQ0FBQyxDQUFDLEVBQUgsQ0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSyxPQUFBLENBQUMsR0FBRyxDQUFDLEVBQUwsQ0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVGLEVBQUUsQ0FBQyxhQUFhLENBQUMsRUFBRSxPQUFPLEVBQUUsVUFBQSxHQUFHLElBQUksT0FBQSxLQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBN0MsQ0FBNkMsRUFBRSxDQUFDLENBQUM7SUFDeEYsQ0FBQztJQUNELE9BQU8sRUFBRTtRQUNMLFlBQVk7WUFDUixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTztnQkFDM0IsUUFBUSxFQUFFLENBQUM7YUFDZCxDQUFDLENBQUM7UUFDUCxDQUFDO1FBQ0QsSUFBSTtRQUVKLENBQUM7UUFDRCxFQUFFO1lBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNyQixJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7YUFDYjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDakM7UUFDTCxDQUFDO1FBQ0QsRUFBRTtZQUFGLGlCQTRCQztZQTNCRyxJQUFNLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO2dCQUM5QixJQUFNLFFBQVEsR0FBRyxDQUFDLENBQUMsS0FBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDekMsSUFBQSxzQ0FBMkQsRUFBeEQsV0FBRyxFQUFFLFlBQW1ELENBQUM7Z0JBRWxFLFFBQVEsSUFBSSxFQUFFO29CQUNWLEtBQUssR0FBRzt3QkFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQUMsTUFBTTtvQkFDeEMsS0FBSyxHQUFHO3dCQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7d0JBQUMsTUFBTTtvQkFDekMsS0FBSyxHQUFHO3dCQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFBQyxNQUFNO29CQUNwQyxLQUFLLEdBQUc7d0JBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3dCQUFDLE1BQU07b0JBQ3JDLEtBQUssR0FBRzt3QkFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7d0JBQUMsTUFBTTtvQkFDdkMsS0FBSyxHQUFHO3dCQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzt3QkFBQyxNQUFNO29CQUN2QyxRQUFRO2lCQUNYO1lBQ0wsQ0FBQyxDQUFDLENBQUM7WUFFSCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUM1QixLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsQ0FBQyxFQUFILENBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDLElBQUssT0FBQSxDQUFDLEdBQUcsQ0FBQyxFQUFMLENBQUssQ0FBQyxDQUFDO1lBRXZFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ3BCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQzthQUN2QjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDakM7WUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUNELE1BQU0sRUFBTixVQUFPLENBQVk7O1lBQ2YsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUM7Z0JBQUEsQ0FBQzthQUNwQztZQUVELElBQU0sU0FBUyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUN6QyxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzFFLElBQUksQ0FBQyxPQUFPO2dCQUNSLEdBQUMsbUJBQWlCLFNBQVMsTUFBRyxJQUFHLEtBQUs7b0JBQ3hDLENBQUM7UUFDUCxDQUFDO1FBQ0QsY0FBYyxZQUFDLENBQVk7O1lBQ3ZCLElBQU0sU0FBUyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUN6QyxJQUFJLFNBQVMsSUFBSSxJQUFJLEVBQUU7Z0JBQ25CLElBQU0sS0FBSyxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztnQkFDNUMsSUFBSSxDQUFDLE9BQU87b0JBQ1IsR0FBQyxtQkFBaUIsS0FBSyxNQUFHLElBQUcsU0FBUzt3QkFDeEMsQ0FBQzthQUNOO1FBQ0wsQ0FBQztLQUNKO0lBQ0QsU0FBUyxFQUFFO1FBQ1Asa0JBQWtCLEVBQUUsVUFBVSxHQUFhO1lBQXZCLGlCQVVuQjtZQVRHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ2pCLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUM5QixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7YUFDMUI7WUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUM7Z0JBQ3pCLEtBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztnQkFDeEIsS0FBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLFNBQVMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxHQUFHLEVBQUUsRUFBTixDQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdEQsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ1osQ0FBQztRQUNELDRCQUE0QixFQUFFLFVBQVUsS0FBZSxFQUFFLFFBQWdCLEVBQUUsTUFBYztZQUNyRixJQUFJLElBQUksR0FBYSxFQUFFLENBQUM7WUFDeEIsSUFBSSxVQUFVLEdBQWUsRUFBRSxDQUFDO1lBQ2hDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdEIsSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxpQkFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO2dCQUM3QyxVQUFVLEdBQUcsb0JBQWEsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7YUFDdkQ7WUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNULElBQUksTUFBQSxFQUFFLFVBQVUsWUFBQTtnQkFDaEIsYUFBYSxFQUFFLG1CQUFZLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDL0UsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIOaXpeacn+aXtumXtOiMg+WbtOmAieaLqeWZqFxyXG4gKi9cclxuaW1wb3J0IHsgZ2V0TGF5b3V0RGF0YSwgY2FsY1NlbEluZGV4LCBmb3JtYXRUaW1lIH0gZnJvbSAnLi91dGlsJztcclxuXHJcbmludGVyZmFjZSBJUmFuZ2VEYXRhIHtcclxuICAgIHZhbHVlOiBudW1iZXJbXTtcclxuICAgIHZpc2libGU6IGJvb2xlYW47XHJcbiAgICBsYXlvdXQ6IHN0cmluZztcclxuICAgIGxheW91dERhdGE6IHN0cmluZ1tdW107XHJcbiAgICBweDJycHhSYXRpbzogbnVtYmVyO1xyXG4gICAgdGltZXI6IG51bWJlciB8IG51bGw7XHJcbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXJbXTtcclxuICAgIHNjcm9sbFRvcDogbnVtYmVyW10sXHJcbiAgICBzZXRUb3A6IGJvb2xlYW47XHJcbiAgICBwcm9ncmVzczogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVJhbmdlIGV4dGVuZHMgV3hDb21wb25lbnQge1xyXG4gICAgZGF0YTogSVJhbmdlRGF0YTtcclxuICAgIHN3aXRjaFBpY2tlcigpOiB2b2lkO1xyXG4gICAgb2soKTogdm9pZDtcclxufVxyXG5cclxuQ29tcG9uZW50PElSYW5nZSwgSVJhbmdlRGF0YT4oe1xyXG4gICAgcHJvcGVydGllczoge1xyXG4gICAgICAgIHZhbHVlOiB7XHJcbiAgICAgICAgICAgIHR5cGU6IEFycmF5LFxyXG4gICAgICAgICAgICB2YWx1ZTogW0RhdGUubm93KCksIERhdGUubm93KCldXHJcbiAgICAgICAgfSxcclxuICAgICAgICBsYXlvdXQ6IHtcclxuICAgICAgICAgICAgdHlwZTogU3RyaW5nLFxyXG4gICAgICAgICAgICB2YWx1ZTogJ3llYXIsIG1vbnRoLCBkYXksIGhvdXJzLCBtaW51dGVzJ1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLy8g6YCJ5Lit55qE57Si5byVXHJcbiAgICAgICAgc2VsZWN0ZWRJbmRleDoge1xyXG4gICAgICAgICAgICB0eXBlOiBBcnJheSxcclxuICAgICAgICAgICAgdmFsdWU6IFswLCAwLCAwLCAwLCAwLCAwXVxyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBkYXRhOiB7XHJcbiAgICAgICAgdmlzaWJsZTogZmFsc2UsXHJcbiAgICAgICAgcHJvZ3Jlc3M6IDAsXHJcbiAgICAgICAgc2Nyb2xsVG9wOiBbXSwgLy8g5rua5Yqo6auY5bqmXHJcbiAgICAgICAgcHgycnB4UmF0aW86IDIsIC8vIDFweC8xcnB4XHJcbiAgICAgICAgdGltZXI6IG51bGwsXHJcbiAgICAgICAgc2V0VG9wOiBmYWxzZSwgLy8g5piv5ZCm5piv55Sx5LqO6K6+572u5rua5Yqo5YC85byV5Y+R55qE5rua5YqoXHJcbiAgICAgICAgZGF0ZTogW10sXHJcbiAgICAgICAgbGF5b3V0RGF0YTogW11cclxuICAgIH0sXHJcbiAgICBhdHRhY2hlZCgpIHtcclxuICAgICAgICB0aGlzLnNldERhdGEoeyB2YWx1ZTogKDxudW1iZXJbXT50aGlzLmRhdGEudmFsdWUpLmZpbHRlcih2ID0+ICEhdikuc29ydCgoYSwgYikgPT4gYSAtIGIpIH0pO1xyXG4gICAgICAgIHd4LmdldFN5c3RlbUluZm8oeyBzdWNjZXNzOiByZXMgPT4gdGhpcy5kYXRhLnB4MnJweFJhdGlvID0gNzUwIC8gcmVzLndpbmRvd1dpZHRoIH0pO1xyXG4gICAgfSxcclxuICAgIG1ldGhvZHM6IHtcclxuICAgICAgICBzd2l0Y2hQaWNrZXIoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICB2aXNpYmxlOiAhdGhpcy5kYXRhLnZpc2libGUsXHJcbiAgICAgICAgICAgICAgICBwcm9ncmVzczogMFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIG5vbmUoKSB7XHJcbiAgICAgICAgICAgIC8vXHJcbiAgICAgICAgfSxcclxuICAgICAgICBnbygpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmRhdGEucHJvZ3Jlc3MpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMub2soKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAwIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSxcclxuICAgICAgICBvaygpIHtcclxuICAgICAgICAgICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YS5sYXlvdXREYXRhLmZvckVhY2goKHYsIGkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkID0gdlt0aGlzLmRhdGEuc2VsZWN0ZWRJbmRleFtpXV07XHJcbiAgICAgICAgICAgICAgICBjb25zdCBbLCBudW0sIHVuaXRdID0gPHN0cmluZ1tdPnNlbGVjdGVkLm1hdGNoKC8oXFxkKykoW15cXGRdKXsxfS8pO1xyXG5cclxuICAgICAgICAgICAgICAgIHN3aXRjaCAodW5pdCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+W5tCc6IGRhdGUuc2V0RnVsbFllYXIoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+aciCc6IGRhdGUuc2V0TW9udGgoK251bSAtIDEpOyBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICfml6UnOiBkYXRlLnNldERhdGUoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+aXtic6IGRhdGUuc2V0SG91cnMoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+WIhic6IGRhdGUuc2V0TWludXRlcygrbnVtKTsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn56eSJzogZGF0ZS5zZXRTZWNvbmRzKCtudW0pOyBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuZGF0YS52YWx1ZTtcclxuICAgICAgICAgICAgdmFsdWVbdGhpcy5kYXRhLnByb2dyZXNzXSA9IGRhdGUuZ2V0VGltZSgpO1xyXG4gICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgPSB2YWx1ZSA9IHZhbHVlLmZpbHRlcih2ID0+ICEhdikuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xyXG5cclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS5wcm9ncmVzcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zd2l0Y2hQaWNrZXIoKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAxIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnRyaWdnZXJFdmVudCgnaW5wdXQnLCB2YWx1ZSwge30pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2Nyb2xsKGU6IEJhc2VFdmVudCk6IGZhbHNlIHwgdm9pZCB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmRhdGEuc2V0VG9wKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kYXRhLnNldFRvcCA9IGZhbHNlOztcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3QgaXRlbUluZGV4ID0gZS50YXJnZXQuZGF0YXNldC5pbmRleDtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBNYXRoLnJvdW5kKGUuZGV0YWlsLnNjcm9sbFRvcCAvIDY0ICogdGhpcy5kYXRhLnB4MnJweFJhdGlvKTtcclxuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgIFtgc2VsZWN0ZWRJbmRleFske2l0ZW1JbmRleH1dYF06IGluZGV4XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0U2Nyb2xsSW5kZXgoZTogQmFzZUV2ZW50KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IGUudGFyZ2V0LmRhdGFzZXQuaW5kZXg7XHJcbiAgICAgICAgICAgIGlmIChpdGVtSW5kZXggIT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaW5kZXggPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbmRleDtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XHJcbiAgICAgICAgICAgICAgICAgICAgW2BzZWxlY3RlZEluZGV4WyR7aW5kZXh9XWBdOiBpdGVtSW5kZXhcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9ic2VydmVyczoge1xyXG4gICAgICAgICdzZWxlY3RlZEluZGV4LioqJzogZnVuY3Rpb24gKHZhbDogbnVtYmVyW10pIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS50aW1lcikge1xyXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuZGF0YS50aW1lcik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmRhdGEudGltZXIgPSBudWxsO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRhdGEudGltZXIgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS5zZXRUb3AgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgc2Nyb2xsVG9wOiB2YWwubWFwKHYgPT4gdiAqIDY0KSB9KTtcclxuICAgICAgICAgICAgfSwgMTAwKTtcclxuICAgICAgICB9LFxyXG4gICAgICAgICd2YWx1ZS4qKiwgcHJvZ3Jlc3MsIGxheW91dCc6IGZ1bmN0aW9uICh2YWx1ZTogbnVtYmVyW10sIHByb2dyZXNzOiBudW1iZXIsIGxheW91dDogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIGxldCBkYXRlOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgICAgICAgICBsZXQgbGF5b3V0RGF0YTogc3RyaW5nW11bXSA9IFtdO1xyXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIGRhdGUgPSB2YWx1ZS5tYXAodiA9PiBmb3JtYXRUaW1lKGxheW91dCwgdikpO1xyXG4gICAgICAgICAgICAgICAgbGF5b3V0RGF0YSA9IGdldExheW91dERhdGEobGF5b3V0LCB2YWx1ZVtwcm9ncmVzc10pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgZGF0ZSwgbGF5b3V0RGF0YSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW5kZXg6IGNhbGNTZWxJbmRleChsYXlvdXREYXRhLCB0aGlzLmRhdGEudmFsdWVbdGhpcy5kYXRhLnByb2dyZXNzXSlcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59KTtcclxuIl19