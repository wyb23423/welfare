"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var util_1 = require("./util");
Component({
    properties: {
        value: {
            type: Array,
            value: []
        },
        layout: {
            type: String,
            value: 'year, month, day, hours, minutes'
        },
        selectedIndex: {
            type: Array,
            value: [0, 0, 0, 0, 0, 0]
        }
    },
    data: {
        visible: false,
        progress: 0,
        scrollTop: [],
        px2rpxRatio: 2,
        timer: null,
        setTop: false,
        date: [],
        layoutData: []
    },
    attached: function () {
        var _this = this;
        this.triggerEvent('input', { value: this._fillValue() }, {});
        wx.getSystemInfo({ success: function (res) { return _this.data.px2rpxRatio = 750 / res.windowWidth; } });
    },
    methods: {
        switchPicker: function () {
            var visible = !this.data.visible;
            this.setData({
                visible: visible,
                progress: 0
            });
            this.triggerEvent('mask', { visible: visible }, {});
        },
        none: function () {
        },
        go: function () {
            if (!this.data.progress) {
                this.ok();
            }
            else {
                this.setData({ progress: 0 });
            }
        },
        ok: function () {
            var _this = this;
            var date = new Date();
            this.data.layoutData.forEach(function (v, i) {
                var selected = v[_this.data.selectedIndex[i]];
                var _a = selected.match(/(\d+)([^\d]){1}/), num = _a[1], unit = _a[2];
                switch (unit) {
                    case '年':
                        date.setFullYear(+num);
                        break;
                    case '月':
                        date.setMonth(+num - 1);
                        break;
                    case '日':
                        date.setDate(+num);
                        break;
                    case '时':
                        date.setHours(+num);
                        break;
                    case '分':
                        date.setMinutes(+num);
                        break;
                    case '秒':
                        date.setSeconds(+num);
                        break;
                    default:
                }
            });
            var value = this.data.value;
            value[this.data.progress] = date.getTime();
            if (this.data.progress) {
                this.switchPicker();
            }
            else {
                value[1] = date.getTime();
                this.setData({ progress: 1 });
            }
            this.data.value = value = value.filter(function (v) { return !!v; }).sort(function (a, b) { return a - b; });
            this.triggerEvent('input', { value: value }, {});
        },
        scroll: function (e) {
            var _a;
            if (this.data.setTop) {
                return this.data.setTop = false;
            }
            var itemIndex = e.target.dataset.index;
            var index = Math.round(e.detail.scrollTop / 64 * this.data.px2rpxRatio);
            this.setData((_a = {},
                _a["selectedIndex[" + itemIndex + "]"] = index,
                _a));
        },
        setScrollIndex: function (e) {
            var _a;
            var itemIndex = e.target.dataset.index;
            if (itemIndex != null) {
                var index = e.currentTarget.dataset.index;
                this.setData((_a = {},
                    _a["selectedIndex[" + index + "]"] = itemIndex,
                    _a));
            }
        },
        _fillValue: function (value) {
            value = (value || this.data.value).filter(function (v) { return !!v; });
            while (value.length < 2) {
                value.push(Date.now());
            }
            return value.sort(function (a, b) { return a - b; });
        }
    },
    observers: {
        'selectedIndex.**': function (val) {
            var _this = this;
            if (this.data.timer) {
                clearTimeout(this.data.timer);
                this.data.timer = null;
            }
            this.data.timer = setTimeout(function () {
                _this.data.setTop = true;
                _this.setData({ scrollTop: val.map(function (v) { return v * 64; }) });
            }, 100);
        },
        'value.**, progress, layout': function (value, progress, layout) {
            this.data.value = value = this._fillValue(value);
            var date = value.map(function (v) { return util_1.formatTime(layout, v); });
            var layoutData = util_1.getLayoutData(layout, value[progress]);
            this.setData({
                date: date, layoutData: layoutData,
                selectedIndex: util_1.calcSelIndex(layoutData, value[progress])
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZV90aW1lX3JhbmdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZGF0ZV90aW1lX3JhbmdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsK0JBQWlFO0FBc0JqRSxTQUFTLENBQXFCO0lBQzFCLFVBQVUsRUFBRTtRQUNSLEtBQUssRUFBRTtZQUNILElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLEVBQUU7U0FDWjtRQUNELE1BQU0sRUFBRTtZQUNKLElBQUksRUFBRSxNQUFNO1lBQ1osS0FBSyxFQUFFLGtDQUFrQztTQUM1QztRQUVELGFBQWEsRUFBRTtZQUNYLElBQUksRUFBRSxLQUFLO1lBQ1gsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDNUI7S0FDSjtJQUNELElBQUksRUFBRTtRQUNGLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLENBQUM7UUFDWCxTQUFTLEVBQUUsRUFBRTtRQUNiLFdBQVcsRUFBRSxDQUFDO1FBQ2QsS0FBSyxFQUFFLElBQUk7UUFDWCxNQUFNLEVBQUUsS0FBSztRQUNiLElBQUksRUFBRSxFQUFFO1FBQ1IsVUFBVSxFQUFFLEVBQUU7S0FDakI7SUFDRCxRQUFRO1FBQVIsaUJBR0M7UUFGRyxJQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLEtBQUssRUFBVyxJQUFLLENBQUMsVUFBVSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN2RSxFQUFFLENBQUMsYUFBYSxDQUFDLEVBQUUsT0FBTyxFQUFFLFVBQUEsR0FBRyxJQUFJLE9BQUEsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQTdDLENBQTZDLEVBQUUsQ0FBQyxDQUFDO0lBQ3hGLENBQUM7SUFDRCxPQUFPLEVBQUU7UUFDTCxZQUFZO1lBQ1IsSUFBTSxPQUFP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QUEsRUFBRSxVQUFVLFlBQUE7Z0JBQ2hCLGFBQWEsRUFBRSxtQkFBWSxDQUFDLFVBQVUsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0QsQ0FBQyxDQUFDO1FBQ1AsQ0FBQztLQUNKO0NBQ0osQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIOaXpeacn+aXtumXtOiMg+WbtOmAieaLqeWZqFxyXG4gKi9cclxuaW1wb3J0IHsgZ2V0TGF5b3V0RGF0YSwgY2FsY1NlbEluZGV4LCBmb3JtYXRUaW1lIH0gZnJvbSAnLi91dGlsJztcclxuXHJcbmludGVyZmFjZSBJUmFuZ2VEYXRhIHtcclxuICAgIHZhbHVlOiBudW1iZXJbXTtcclxuICAgIHZpc2libGU6IGJvb2xlYW47XHJcbiAgICBsYXlvdXQ6IHN0cmluZztcclxuICAgIGxheW91dERhdGE6IHN0cmluZ1tdW107XHJcbiAgICBweDJycHhSYXRpbzogbnVtYmVyO1xyXG4gICAgdGltZXI6IG51bWJlciB8IG51bGw7XHJcbiAgICBzZWxlY3RlZEluZGV4OiBudW1iZXJbXTtcclxuICAgIHNjcm9sbFRvcDogbnVtYmVyW107XHJcbiAgICBzZXRUb3A6IGJvb2xlYW47XHJcbiAgICBwcm9ncmVzczogbnVtYmVyO1xyXG59XHJcblxyXG5pbnRlcmZhY2UgSVJhbmdlIGV4dGVuZHMgV3hDb21wb25lbnQge1xyXG4gICAgZGF0YTogSVJhbmdlRGF0YTtcclxuICAgIHN3aXRjaFBpY2tlcigpOiB2b2lkO1xyXG4gICAgb2soKTogdm9pZDtcclxuICAgIF9maWxsVmFsdWUodmFsdWU/OiBudW1iZXJbXSk6IG51bWJlcltdO1xyXG59XHJcblxyXG5Db21wb25lbnQ8SVJhbmdlLCBJUmFuZ2VEYXRhPih7XHJcbiAgICBwcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgdmFsdWU6IHtcclxuICAgICAgICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgICAgICAgIHZhbHVlOiBbXVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbGF5b3V0OiB7XHJcbiAgICAgICAgICAgIHR5cGU6IFN0cmluZyxcclxuICAgICAgICAgICAgdmFsdWU6ICd5ZWFyLCBtb250aCwgZGF5LCBob3VycywgbWludXRlcydcclxuICAgICAgICB9LFxyXG4gICAgICAgIC8vIOmAieS4reeahOe0ouW8lVxyXG4gICAgICAgIHNlbGVjdGVkSW5kZXg6IHtcclxuICAgICAgICAgICAgdHlwZTogQXJyYXksXHJcbiAgICAgICAgICAgIHZhbHVlOiBbMCwgMCwgMCwgMCwgMCwgMF1cclxuICAgICAgICB9XHJcbiAgICB9LFxyXG4gICAgZGF0YToge1xyXG4gICAgICAgIHZpc2libGU6IGZhbHNlLFxyXG4gICAgICAgIHByb2dyZXNzOiAwLFxyXG4gICAgICAgIHNjcm9sbFRvcDogW10sIC8vIOa7muWKqOmrmOW6plxyXG4gICAgICAgIHB4MnJweFJhdGlvOiAyLCAvLyAxcHgvMXJweFxyXG4gICAgICAgIHRpbWVyOiBudWxsLFxyXG4gICAgICAgIHNldFRvcDogZmFsc2UsIC8vIOaYr+WQpuaYr+eUseS6juiuvue9rua7muWKqOWAvOW8leWPkeeahOa7muWKqFxyXG4gICAgICAgIGRhdGU6IFtdLFxyXG4gICAgICAgIGxheW91dERhdGE6IFtdXHJcbiAgICB9LFxyXG4gICAgYXR0YWNoZWQoKSB7XHJcbiAgICAgICAgdGhpcy50cmlnZ2VyRXZlbnQoJ2lucHV0JywgeyB2YWx1ZTogKDxJUmFuZ2U+dGhpcykuX2ZpbGxWYWx1ZSgpIH0sIHt9KTtcclxuICAgICAgICB3eC5nZXRTeXN0ZW1JbmZvKHsgc3VjY2VzczogcmVzID0+IHRoaXMuZGF0YS5weDJycHhSYXRpbyA9IDc1MCAvIHJlcy53aW5kb3dXaWR0aCB9KTtcclxuICAgIH0sXHJcbiAgICBtZXRob2RzOiB7XHJcbiAgICAgICAgc3dpdGNoUGlja2VyKCkge1xyXG4gICAgICAgICAgICBjb25zdCB2aXNpYmxlID0gIXRoaXMuZGF0YS52aXNpYmxlO1xyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgdmlzaWJsZSxcclxuICAgICAgICAgICAgICAgIHByb2dyZXNzOiAwXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyRXZlbnQoJ21hc2snLCB7IHZpc2libGUgfSwge30pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgbm9uZSgpIHtcclxuICAgICAgICAgICAgLy9cclxuICAgICAgICB9LFxyXG4gICAgICAgIGdvKCkge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZGF0YS5wcm9ncmVzcykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vaygpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgcHJvZ3Jlc3M6IDAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIG9rKCkge1xyXG4gICAgICAgICAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoKTtcclxuICAgICAgICAgICAgdGhpcy5kYXRhLmxheW91dERhdGEuZm9yRWFjaCgodiwgaSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VsZWN0ZWQgPSB2W3RoaXMuZGF0YS5zZWxlY3RlZEluZGV4W2ldXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IFssIG51bSwgdW5pdF0gPSA8c3RyaW5nW10+c2VsZWN0ZWQubWF0Y2goLyhcXGQrKShbXlxcZF0pezF9Lyk7XHJcblxyXG4gICAgICAgICAgICAgICAgc3dpdGNoICh1bml0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn5bm0JzogZGF0ZS5zZXRGdWxsWWVhcigrbnVtKTsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn5pyIJzogZGF0ZS5zZXRNb250aCgrbnVtIC0gMSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGNhc2UgJ+aXpSc6IGRhdGUuc2V0RGF0ZSgrbnVtKTsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn5pe2JzogZGF0ZS5zZXRIb3VycygrbnVtKTsgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAn5YiGJzogZGF0ZS5zZXRNaW51dGVzKCtudW0pOyBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlICfnp5InOiBkYXRlLnNldFNlY29uZHMoK251bSk7IGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5kYXRhLnZhbHVlO1xyXG4gICAgICAgICAgICB2YWx1ZVt0aGlzLmRhdGEucHJvZ3Jlc3NdID0gZGF0ZS5nZXRUaW1lKCk7XHJcblxyXG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhLnByb2dyZXNzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN3aXRjaFBpY2tlcigpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdmFsdWVbMV0gPSBkYXRlLmdldFRpbWUoKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7IHByb2dyZXNzOiAxIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICB0aGlzLmRhdGEudmFsdWUgPSB2YWx1ZSA9IHZhbHVlLmZpbHRlcih2ID0+ICEhdikuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy50cmlnZ2VyRXZlbnQoJ2lucHV0JywgeyB2YWx1ZSB9LCB7fSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzY3JvbGwoZTogQmFzZUV2ZW50KTogZmFsc2UgfCB2b2lkIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuZGF0YS5zZXRUb3ApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRhdGEuc2V0VG9wID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1JbmRleCA9IGUudGFyZ2V0LmRhdGFzZXQuaW5kZXg7XHJcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gTWF0aC5yb3VuZChlLmRldGFpbC5zY3JvbGxUb3AgLyA2NCAqIHRoaXMuZGF0YS5weDJycHhSYXRpbyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgW2BzZWxlY3RlZEluZGV4WyR7aXRlbUluZGV4fV1gXTogaW5kZXhcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRTY3JvbGxJbmRleChlOiBCYXNlRXZlbnQpIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbUluZGV4ID0gZS50YXJnZXQuZGF0YXNldC5pbmRleDtcclxuICAgICAgICAgICAgaWYgKGl0ZW1JbmRleCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4O1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcclxuICAgICAgICAgICAgICAgICAgICBbYHNlbGVjdGVkSW5kZXhbJHtpbmRleH1dYF06IGl0ZW1JbmRleFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIF9maWxsVmFsdWUodmFsdWU/OiBudW1iZXJbXSkge1xyXG4gICAgICAgICAgICB2YWx1ZSA9ICh2YWx1ZSB8fCB0aGlzLmRhdGEudmFsdWUpLmZpbHRlcih2ID0+ICEhdik7XHJcbiAgICAgICAgICAgIHdoaWxlICh2YWx1ZS5sZW5ndGggPCAyKSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZS5wdXNoKERhdGUubm93KCkpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWUuc29ydCgoYSwgYikgPT4gYSAtIGIpO1xyXG4gICAgICAgIH1cclxuICAgIH0sXHJcbiAgICBvYnNlcnZlcnM6IHtcclxuICAgICAgICAnc2VsZWN0ZWRJbmRleC4qKicodmFsOiBudW1iZXJbXSkge1xyXG4gICAgICAgICAgICBpZiAodGhpcy5kYXRhLnRpbWVyKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5kYXRhLnRpbWVyKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGF0YS50aW1lciA9IG51bGw7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHRoaXMuZGF0YS50aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5kYXRhLnNldFRvcCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoeyBzY3JvbGxUb3A6IHZhbC5tYXAodiA9PiB2ICogNjQpIH0pO1xyXG4gICAgICAgICAgICB9LCAxMDApO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgJ3ZhbHVlLioqLCBwcm9ncmVzcywgbGF5b3V0Jyh2YWx1ZTogbnVtYmVyW10sIHByb2dyZXNzOiBudW1iZXIsIGxheW91dDogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGF0YS52YWx1ZSA9IHZhbHVlID0gdGhpcy5fZmlsbFZhbHVlKHZhbHVlKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSB2YWx1ZS5tYXAodiA9PiBmb3JtYXRUaW1lKGxheW91dCwgdikpO1xyXG4gICAgICAgICAgICBjb25zdCBsYXlvdXREYXRhID0gZ2V0TGF5b3V0RGF0YShsYXlvdXQsIHZhbHVlW3Byb2dyZXNzXSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xyXG4gICAgICAgICAgICAgICAgZGF0ZSwgbGF5b3V0RGF0YSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkSW5kZXg6IGNhbGNTZWxJbmRleChsYXlvdXREYXRhLCB2YWx1ZVtwcm9ncmVzc10pXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufSk7XHJcbiJdfQ==