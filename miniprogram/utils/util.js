"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var index_1 = require("../constant/index");
var http_1 = require("./http");
var status_1 = require("../constant/status");
function formatTime(date) {
    var _a = resolveTime(date), year = _a.year, month = _a.month, day = _a.day, hour = _a.hour, minute = _a.minute;
    return [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute].map(formatNumber).join(':');
}
exports.formatTime = formatTime;
function resolveTime(time) {
    var date = time instanceof Date ? time : new Date(time);
    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();
    return { year: year, month: month, day: day, hour: hour, minute: minute };
}
exports.resolveTime = resolveTime;
function getOptions(path) {
    var page = getCurrentPages().pop();
    if (!(page && page.route === path)) {
        return wx.showModal({
            title: '非法访问',
            content: '路由参数错误，即将返回主页',
            showCancel: false,
            complete: function () {
                wx.reLaunch({ url: '/pages/index/index' });
            }
        });
    }
    return page.options || {};
}
exports.getOptions = getOptions;
function parseData(v, i) {
    if (i === void 0) { i = 0; }
    v.authStr = Reflect.get(index_1.AUTHENTICATION, v.authentication) || '未认证';
    v.originImg = v.img;
    v.img = v.img + '?thumb=true';
    v.sign = v.attended || v.sign || 0;
    v.size = v.size || 0;
    v.index = i;
    v.isCollected = !!v.liked;
    return v;
}
exports.parseData = parseData;
function upload(newSrc, oldSrc) {
    if (!newSrc) {
        console.warn('文件路径不能为空');
        return Promise.resolve(null);
    }
    if (oldSrc === newSrc) {
        return Promise.resolve(null);
    }
    return http_1.uploadFile({
        url: '/api/file',
        name: 'file',
        filePath: newSrc
    }).then(function (res) { return res.data; });
}
exports.upload = upload;
function updateStatus(component, index) {
    var data = component.data.list[index];
    if (data.status === status_1.GOODS_STATUS.AUDITING) {
        return wx.showToast({ icon: 'none', title: '商品审核中' });
    }
    var isNormal = data.status === status_1.GOODS_STATUS.NORMAL;
    wx.showModal({
        content: (isNormal ? '下' : '上') + '架该商品?',
        success: function (_a) {
            var confirm = _a.confirm;
            if (!confirm) {
                return;
            }
            var status = isNormal ? status_1.GOODS_STATUS.SOLD_OUT : status_1.GOODS_STATUS.NORMAL;
            http_1.request({
                url: '/api/commodity',
                data: { id: data.id, status: status },
                method: 'POST'
            })
                .then(function () {
                var _a;
                return component.setData((_a = {}, _a["list[" + index + "].status"] = status, _a));
            })
                .then(function () { return wx.showToast({ title: '操作成功' }); })
                .catch(console.log);
        }
    });
}
exports.updateStatus = updateStatus;
function deleteGoods(component, index) {
    var list = component.data.list;
    var data = list[index];
    wx.showModal({
        content: '删除该商品?',
        success: function (_a) {
            var confirm = _a.confirm;
            if (!confirm) {
                return;
            }
            http_1.request({
                url: '/api/commodity',
                data: { id: data.id },
                method: 'DELETE'
            })
                .then(function () { return component.reflash(); })
                .then(function () { return wx.showToast({ title: '删除成功' }); })
                .catch(console.log);
        }
    });
}
exports.deleteGoods = deleteGoods;
function formatNumber(n) {
    var str = n.toString();
    return str[1] ? str : '0' + str;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInV0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwyQ0FBbUQ7QUFDbkQsK0JBQTZDO0FBRTdDLDZDQUFrRDtBQUVsRCxTQUFnQixVQUFVLENBQUMsSUFBVTtJQUM3QixJQUFBLHNCQUFvRCxFQUFuRCxjQUFJLEVBQUUsZ0JBQUssRUFBRSxZQUFHLEVBQUUsY0FBSSxFQUFFLGtCQUEyQixDQUFDO0lBQzNELE9BQU8sQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDM0csQ0FBQztBQUhELGdDQUdDO0FBS0QsU0FBZ0IsV0FBVyxDQUFDLElBQW1CO0lBQzNDLElBQU0sSUFBSSxHQUFHLElBQUksWUFBWSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFMUQsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hDLElBQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEMsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQzNCLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixJQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFFakMsT0FBTyxFQUFDLElBQUksTUFBQSxFQUFFLEtBQUssT0FBQSxFQUFFLEdBQUcsS0FBQSxFQUFFLElBQUksTUFBQSxFQUFFLE1BQU0sUUFBQSxFQUFDLENBQUM7QUFDNUMsQ0FBQztBQVZELGtDQVVDO0FBS0QsU0FBZ0IsVUFBVSxDQUFDLElBQVk7SUFDckMsSUFBTSxJQUFJLEdBQUcsZUFBZSxFQUFtQixDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQ3RELElBQUksQ0FBQyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxFQUFFO1FBQ2xDLE9BQU8sRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUNsQixLQUFLLEVBQUUsTUFBTTtZQUNiLE9BQU8sRUFBRSxlQUFlO1lBQ3hCLFVBQVUsRUFBRSxLQUFLO1lBQ2pCLFFBQVE7Z0JBQ04sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsRUFBRSxvQkFBb0IsRUFBRSxDQUFDLENBQUM7WUFDN0MsQ0FBQztTQUNGLENBQUMsQ0FBQztLQUNKO0lBRUQsT0FBTyxJQUFJLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQztBQUM1QixDQUFDO0FBZEQsZ0NBY0M7QUFPRCxTQUFnQixTQUFTLENBQTZDLENBQUksRUFBRSxDQUFhO0lBQWIsa0JBQUEsRUFBQSxLQUFhO0lBQ2pGLENBQUUsQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBYyxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsSUFBSSxLQUFLLENBQUM7SUFFMUUsQ0FBQyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDO0lBQ3BCLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxhQUFhLENBQUM7SUFDOUIsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsUUFBUSxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO0lBQ25DLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUM7SUFDckIsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDWixDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBRTFCLE9BQU8sQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQVhELDhCQVdDO0FBRUQsU0FBZ0IsTUFBTSxDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQ2pELElBQUcsQ0FBQyxNQUFNLEVBQUU7UUFDUixPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3pCLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FBTSxJQUFJLENBQUMsQ0FBQztLQUNyQztJQUVELElBQUcsTUFBTSxLQUFLLE1BQU0sRUFBRTtRQUNsQixPQUFPLE9BQU8sQ0FBQyxPQUFPLENBQU0sSUFBSSxDQUFDLENBQUM7S0FDckM7SUFFRCxPQUFPLGlCQUFVLENBQVM7UUFDdEIsR0FBRyxFQUFFLFdBQVc7UUFDaEIsSUFBSSxFQUFFLE1BQU07UUFDWixRQUFRLEVBQUUsTUFBTTtLQUNuQixDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBUixDQUFRLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBZkQsd0JBZUM7QUFPRCxTQUFnQixZQUFZLENBQUMsU0FBd0IsRUFBRSxLQUFhO0lBQ2hFLElBQU0sSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLElBQUcsSUFBSSxDQUFDLE1BQU0sS0FBSyxxQkFBWSxDQUFDLFFBQVEsRUFBRTtRQUN0QyxPQUFPLEVBQUUsQ0FBQyxTQUFTLENBQUMsRUFBQyxJQUFJLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUMsQ0FBQyxDQUFDO0tBQ3ZEO0lBRUQsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sS0FBSyxxQkFBWSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxFQUFFLENBQUMsU0FBUyxDQUFDO1FBQ1QsT0FBTyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBLEdBQUcsQ0FBQyxHQUFHLE9BQU87UUFDeEMsT0FBTyxFQUFFLFVBQUMsRUFBUztnQkFBUixvQkFBTztZQUNkLElBQUcsQ0FBQyxPQUFPLEVBQUU7Z0JBQ1QsT0FBTzthQUNWO1lBRUQsSUFBTSxNQUFNLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxxQkFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMscUJBQVksQ0FBQyxNQUFNLENBQUM7WUFDdEUsY0FBTyxDQUFDO2dCQUNKLEdBQUcsRUFBRSxnQkFBZ0I7Z0JBQ3JCLElBQUksRUFBRSxFQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLE1BQU0sUUFBQSxFQUFDO2dCQUMzQixNQUFNLEVBQUUsTUFBTTthQUNqQixDQUFDO2lCQUNHLElBQUksQ0FBQzs7Z0JBQU0sT0FBQSxTQUFTLENBQUMsT0FBTyxXQUFFLEdBQUMsVUFBUSxLQUFLLGFBQVUsSUFBRyxNQUFNLE1BQUU7WUFBdEQsQ0FBc0QsQ0FBQztpQkFDbEUsSUFBSSxDQUFDLGNBQU0sT0FBQSxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUMsS0FBSyxFQUFFLE1BQU0sRUFBQyxDQUFDLEVBQTdCLENBQTZCLENBQUM7aUJBQ3pDLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUIsQ0FBQztLQUNKLENBQUMsQ0FBQztBQUNQLENBQUM7QUF6QkQsb0NBeUJDO0FBS0QsU0FBZ0IsV0FBVyxDQUFDLFNBQXdCLEVBQUUsS0FBYTtJQUMvRCxJQUFNLElBQUksR0FBaUIsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7SUFDL0MsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pCLEVBQUUsQ0FBQyxTQUFTLENBQUM7UUFDVCxPQUFPLEVBQUUsUUFBUTtRQUNqQixPQUFPLEVBQUUsVUFBQyxFQUFTO2dCQUFSLG9CQUFPO1lBQ2QsSUFBRyxDQUFDLE9BQU8sRUFBRTtnQkFDVCxPQUFPO2FBQ1Y7WUFFRCxjQUFPLENBQUM7Z0JBQ0osR0FBRyxFQUFFLGdCQUFnQjtnQkFDckIsSUFBSSxFQUFFLEVBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUM7Z0JBQ25CLE1BQU0sRUFBRSxRQUFRO2FBQ25CLENBQUM7aUJBQ0csSUFBSSxDQUFDLGNBQU0sT0FBQSxTQUFTLENBQUMsT0FBTyxFQUFFLEVBQW5CLENBQW1CLENBQUM7aUJBQy9CLElBQUksQ0FBQyxjQUFNLE9BQUEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFDLEtBQUssRUFBRSxNQUFNLEVBQUMsQ0FBQyxFQUE3QixDQUE2QixDQUFDO2lCQUN6QyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVCLENBQUM7S0FDSixDQUFDLENBQUM7QUFDUCxDQUFDO0FBcEJELGtDQW9CQztBQUVELFNBQVMsWUFBWSxDQUFDLENBQVM7SUFDN0IsSUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3pCLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7QUFDbEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFVVEhFTlRJQ0FUSU9OIH0gZnJvbSAnLi4vY29uc3RhbnQvaW5kZXgnO1xyXG5pbXBvcnQgeyB1cGxvYWRGaWxlLCByZXF1ZXN0IH0gZnJvbSAnLi9odHRwJztcclxuaW1wb3J0IHsgTGlzdENvbXBvbmVudCB9IGZyb20gJy4uL2JlaGF2aW9yL3BhZ2VfcXVlcnknO1xyXG5pbXBvcnQgeyBHT09EU19TVEFUVVMgfSBmcm9tICcuLi9jb25zdGFudC9zdGF0dXMnO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZvcm1hdFRpbWUoZGF0ZTogRGF0ZSk6IHN0cmluZyB7XHJcbiAgY29uc3Qge3llYXIsIG1vbnRoLCBkYXksIGhvdXIsIG1pbnV0ZX0gPSByZXNvbHZlVGltZShkYXRlKTtcclxuICByZXR1cm4gW3llYXIsIG1vbnRoLCBkYXldLm1hcChmb3JtYXROdW1iZXIpLmpvaW4oJy8nKSArICcgJyArIFtob3VyLCBtaW51dGVdLm1hcChmb3JtYXROdW1iZXIpLmpvaW4oJzonKTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWwhuaXtumXtOWIhuino+S4uiDlubTmnIjml6XvvIzml7bliIbnp5JcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiByZXNvbHZlVGltZSh0aW1lOiBudW1iZXIgfCBEYXRlKSB7XHJcbiAgICBjb25zdCBkYXRlID0gdGltZSBpbnN0YW5jZW9mIERhdGUgPyB0aW1lIDogbmV3IERhdGUodGltZSk7XHJcblxyXG4gICAgY29uc3QgeWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcclxuICAgIGNvbnN0IG1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsgMTtcclxuICAgIGNvbnN0IGRheSA9IGRhdGUuZ2V0RGF0ZSgpO1xyXG4gICAgY29uc3QgaG91ciA9IGRhdGUuZ2V0SG91cnMoKTtcclxuICAgIGNvbnN0IG1pbnV0ZSA9IGRhdGUuZ2V0TWludXRlcygpO1xyXG5cclxuICAgIHJldHVybiB7eWVhciwgbW9udGgsIGRheSwgaG91ciwgbWludXRlfTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOiOt+WPluW9k+WJjemhtemdoui3r+eUseWPguaVsFxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE9wdGlvbnMocGF0aDogc3RyaW5nKSB7XHJcbiAgY29uc3QgcGFnZSA9IGdldEN1cnJlbnRQYWdlczxJQW55T2JqZWN0LCBhbnk+KCkucG9wKCk7XHJcbiAgaWYgKCEocGFnZSAmJiBwYWdlLnJvdXRlID09PSBwYXRoKSkge1xyXG4gICAgcmV0dXJuIHd4LnNob3dNb2RhbCh7XHJcbiAgICAgIHRpdGxlOiAn6Z2e5rOV6K6/6ZeuJyxcclxuICAgICAgY29udGVudDogJ+i3r+eUseWPguaVsOmUmeivr++8jOWNs+Wwhui/lOWbnuS4u+mhtScsXHJcbiAgICAgIHNob3dDYW5jZWw6IGZhbHNlLFxyXG4gICAgICBjb21wbGV0ZSgpIHtcclxuICAgICAgICB3eC5yZUxhdW5jaCh7IHVybDogJy9wYWdlcy9pbmRleC9pbmRleCcgfSk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHBhZ2Uub3B0aW9ucyB8fCB7fTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWwhuS7juacjeWKoeWZqOiOt+WPlueahOaVsOaNruWkhOeQhuaIkOmcgOimgeeahOaVsOaNruagvOW8j1xyXG4gKiBAcGFyYW0gdiDmupDmlbDmja5cclxuICogQHBhcmFtIGkg5rqQ5pWw5o2u5Zyo5pWw5o2u5YiX6KGo5Lit55qE57Si5byVXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VEYXRhPFQgZXh0ZW5kcyBJQWN0aXZlIHwgSUNvbW1vZGl0eSB8IElNZXJjaGFudD4odjogVCwgaTogbnVtYmVyID0gMCk6IFQge1xyXG4gICg8YW55PnYpLmF1dGhTdHIgPSBSZWZsZWN0LmdldChBVVRIRU5USUNBVElPTiwgdi5hdXRoZW50aWNhdGlvbikgfHwgJ+acquiupOivgSc7XHJcblxyXG4gIHYub3JpZ2luSW1nID0gdi5pbWc7IC8vIOS/neWtmOWOn+Wni+WbvueJh1xyXG4gIHYuaW1nID0gdi5pbWcgKyAnP3RodW1iPXRydWUnOyAvLyDojrflj5bljovnvKnlm77niYfot6/lvoRcclxuICB2LnNpZ24gPSB2LmF0dGVuZGVkIHx8IHYuc2lnbiB8fCAwOyAvLyDorr7nva7lt7LlhZHmjaIv5Y+C5Yqg6buY6K6k5YC8XHJcbiAgdi5zaXplID0gdi5zaXplIHx8IDA7IC8vIOiuvue9ruWPr+WFkeaNoi/lj4LliqDpu5jorqTlgLxcclxuICB2LmluZGV4ID0gaTsgLy8g6K6+572u57Si5byVXHJcbiAgdi5pc0NvbGxlY3RlZCA9ICEhdi5saWtlZDsgLy8g6L2s5YyW5piv5ZCm5pS26JePL+WFs+azqOWtl+auteWQjSjor6XlrZfmrrXmmK/liY3nq6/lrozmiJDlkI7mnI3liqHnq6/miY3lnKjov5Tlm57mlbDmja7kuK3mt7vliqDnmoQpXHJcblxyXG4gIHJldHVybiB2O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXBsb2FkKG5ld1NyYzogc3RyaW5nLCBvbGRTcmM6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBpZighbmV3U3JjKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCfmlofku7bot6/lvoTkuI3og73kuLrnqbonKTtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDxhbnk+bnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYob2xkU3JjID09PSBuZXdTcmMpIHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKDxhbnk+bnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHVwbG9hZEZpbGU8c3RyaW5nPih7XHJcbiAgICAgICAgdXJsOiAnL2FwaS9maWxlJyxcclxuICAgICAgICBuYW1lOiAnZmlsZScsXHJcbiAgICAgICAgZmlsZVBhdGg6IG5ld1NyY1xyXG4gICAgfSkudGhlbihyZXMgPT4gcmVzLmRhdGEpO1xyXG59XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gKiDmm7TmlrDllYblk4HnirbmgIFcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVTdGF0dXMoY29tcG9uZW50OiBMaXN0Q29tcG9uZW50LCBpbmRleDogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBkYXRhID0gY29tcG9uZW50LmRhdGEubGlzdFtpbmRleF07XHJcbiAgICBpZihkYXRhLnN0YXR1cyA9PT0gR09PRFNfU1RBVFVTLkFVRElUSU5HKSB7XHJcbiAgICAgICAgcmV0dXJuIHd4LnNob3dUb2FzdCh7aWNvbjogJ25vbmUnLCB0aXRsZTogJ+WVhuWTgeWuoeaguOS4rSd9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpc05vcm1hbCA9IGRhdGEuc3RhdHVzID09PSBHT09EU19TVEFUVVMuTk9STUFMO1xyXG4gICAgd3guc2hvd01vZGFsKHtcclxuICAgICAgICBjb250ZW50OiAoaXNOb3JtYWwgPyAn5LiLJyA6J+S4iicpICsgJ+aetuivpeWVhuWTgT8nLFxyXG4gICAgICAgIHN1Y2Nlc3M6ICh7Y29uZmlybX0pID0+IHtcclxuICAgICAgICAgICAgaWYoIWNvbmZpcm0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gaXNOb3JtYWwgPyBHT09EU19TVEFUVVMuU09MRF9PVVQgOiBHT09EU19TVEFUVVMuTk9STUFMO1xyXG4gICAgICAgICAgICByZXF1ZXN0KHtcclxuICAgICAgICAgICAgICAgIHVybDogJy9hcGkvY29tbW9kaXR5JyxcclxuICAgICAgICAgICAgICAgIGRhdGE6IHtpZDogZGF0YS5pZCwgc3RhdHVzfSxcclxuICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnXHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiBjb21wb25lbnQuc2V0RGF0YSh7W2BsaXN0WyR7aW5kZXh9XS5zdGF0dXNgXTogc3RhdHVzfSkpXHJcbiAgICAgICAgICAgICAgICAudGhlbigoKSA9PiB3eC5zaG93VG9hc3Qoe3RpdGxlOiAn5pON5L2c5oiQ5YqfJ30pKVxyXG4gICAgICAgICAgICAgICAgLmNhdGNoKGNvbnNvbGUubG9nKTtcclxuICAgICAgICB9XHJcbiAgICB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIOWIoOmZpOWVhuWTgVxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGRlbGV0ZUdvb2RzKGNvbXBvbmVudDogTGlzdENvbXBvbmVudCwgaW5kZXg6IG51bWJlcikge1xyXG4gICAgY29uc3QgbGlzdDogSUNvbW1vZGl0eVtdID0gY29tcG9uZW50LmRhdGEubGlzdDtcclxuICAgIGNvbnN0IGRhdGEgPSBsaXN0W2luZGV4XTtcclxuICAgIHd4LnNob3dNb2RhbCh7XHJcbiAgICAgICAgY29udGVudDogJ+WIoOmZpOivpeWVhuWTgT8nLFxyXG4gICAgICAgIHN1Y2Nlc3M6ICh7Y29uZmlybX0pID0+IHtcclxuICAgICAgICAgICAgaWYoIWNvbmZpcm0pIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgcmVxdWVzdCh7XHJcbiAgICAgICAgICAgICAgICB1cmw6ICcvYXBpL2NvbW1vZGl0eScsXHJcbiAgICAgICAgICAgICAgICBkYXRhOiB7aWQ6IGRhdGEuaWR9LFxyXG4gICAgICAgICAgICAgICAgbWV0aG9kOiAnREVMRVRFJ1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4gY29tcG9uZW50LnJlZmxhc2goKSlcclxuICAgICAgICAgICAgICAgIC50aGVuKCgpID0+IHd4LnNob3dUb2FzdCh7dGl0bGU6ICfliKDpmaTmiJDlip8nfSkpXHJcbiAgICAgICAgICAgICAgICAuY2F0Y2goY29uc29sZS5sb2cpO1xyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmb3JtYXROdW1iZXIobjogbnVtYmVyKSB7XHJcbiAgY29uc3Qgc3RyID0gbi50b1N0cmluZygpO1xyXG4gIHJldHVybiBzdHJbMV0gPyBzdHIgOiAnMCcgKyBzdHI7XHJcbn1cclxuIl19